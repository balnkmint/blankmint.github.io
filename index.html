<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>blankmintçš„è´ªåƒçŒ«æ¸¸æˆ - Rust + WASM</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: #00ff00;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff00;
        }

        .main-container {
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 50px;
            width: 100%;
            max-width: 1200px;
            padding-left: 10px;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .virtual-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #1a1a1a;
            padding: 25px;
            border: 4px solid #000000;
            border-radius: 15px;
            box-shadow:
                0 0 15px rgba(0, 255, 0, 0.2),
                inset 0 0 10px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
            margin-right: 60px;
            position: relative;
            margin-left: 0;
        }

        .virtual-controls h4 {
            color: #00ff00;
            margin: 0 0 15px 0;
            font-size: 14px;
        }

        .control-pad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 5px;
            width: 120px;
            height: 120px;
        }

        .control-btn {
            background-color: #00ff00;
            color: #000;
            border: 3px solid #000000;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            box-shadow:
                0 3px 6px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .control-btn:hover {
            background-color: #00cc00;
            transform: scale(1.05);
        }

        .control-btn:active {
            background-color: #009900;
            transform: scale(0.95);
        }

        .control-btn.up {
            grid-column: 2;
            grid-row: 1;
        }

        .control-btn.left {
            grid-column: 1;
            grid-row: 2;
        }

        .control-btn.right {
            grid-column: 3;
            grid-row: 2;
        }

        .control-btn.down {
            grid-column: 2;
            grid-row: 3;
        }

        #game-canvas {
            border: 2px solid #00ff00;
            border-radius: 5px;
            cursor: crosshair;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .score {
            color: #00ff00;
        }

        .controls {
            text-align: center;
            margin-top: 20px;
            max-width: 600px;
        }

        .controls h3 {
            color: #00ff00;
            margin-bottom: 10px;
        }

        .controls p {
            margin: 5px 0;
            color: #cccccc;
        }

        button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #00cc00;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .loading {
            color: #00ff00;
            font-size: 18px;
            text-align: center;
        }

        .error {
            color: #ff0000;
            font-size: 16px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
                align-items: center;
                padding-left: 10px;
            }

            .virtual-controls {
                order: 2;
                margin-top: 20px;
                margin-right: 0;
            }

            .game-container {
                order: 1;
            }
        }

        @media (max-width: 650px) {
            body {
                padding: 10px;
            }

            #game-canvas {
                width: 100%;
                max-width: 400px;
                height: auto;
            }

            .game-container {
                padding: 15px;
            }

            .virtual-controls {
                margin-top: 15px;
            }

            .control-pad {
                width: 100px;
                height: 100px;
            }

            .control-btn {
                font-size: 14px;
            }

            h1 {
                font-size: 24px;
            }
        }

        @media (max-width: 480px) {
            #game-canvas {
                max-width: 320px;
            }

            .control-pad {
                width: 90px;
                height: 90px;
            }

            .control-btn {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ± blankmintçš„è´ªåƒçŒ«æ¸¸æˆ</h1>

    <div class="main-container">
        <!-- è™šæ‹Ÿæ§åˆ¶å™¨ -->
        <div class="virtual-controls">
            <h4>è§¦å±æ§åˆ¶</h4>
            <div class="control-pad">
                <button class="control-btn up" data-direction="ArrowUp">â†‘</button>
                <button class="control-btn left" data-direction="ArrowLeft">â†</button>
                <button class="control-btn right" data-direction="ArrowRight">â†’</button>
                <button class="control-btn down" data-direction="ArrowDown">â†“</button>
            </div>
        </div>

        <!-- æ¸¸æˆä¸»ä½“ -->
        <div class="game-container">
            <div class="game-info">
                <div class="score">åˆ†æ•°: <span id="score">0</span></div>
                <div>çŠ¶æ€: <span id="status">åŠ è½½ä¸­...</span></div>
            </div>

            <canvas id="game-canvas" width="600" height="400"></canvas>

            <div class="controls">
                <button id="restart-btn" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
                <button id="pause-btn" onclick="togglePause()">æš‚åœ/ç»§ç»­</button>
                <h3>æ¸¸æˆè¯´æ˜</h3>
                <p>âŒ¨ï¸ é”®ç›˜ï¼šæ–¹å‘é”®æˆ–WASDæ§åˆ¶çŒ«å’ª</p>
                <p>ğŸ“± æ‰‹æœºï¼šç‚¹å‡»å·¦ä¾§æ–¹å‘æŒ‰é’®</p>
                <p>ğŸ’© åƒç²‘ç²‘è·å¾—åˆ†æ•°å¹¶æˆé•¿</p>
                <p>âš ï¸ ä¸è¦æ’åˆ°è‡ªå·±çš„èº«ä½“</p>
                <p>â¸ï¸ æŒ‰ç©ºæ ¼é”®æˆ–ç‚¹å‡»æš‚åœæŒ‰é’®æš‚åœæ¸¸æˆ</p>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ¸¸æˆ...</div>
    <div id="error" class="error" style="display: none;"></div>

    <script type="module">
        // åŠ¨æ€å¯¼å…¥ä»¥æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†
        let init, Game;

        let game;
        let canvas;
        let ctx;
        let animationId;

        async function run() {
            try {
                console.log('å¼€å§‹åŠ è½½JSç»‘å®š...');
                document.getElementById('loading').textContent = 'æ­£åœ¨åŠ è½½æ¸¸æˆæ¨¡å—...';

                // åŠ¨æ€å¯¼å…¥JSç»‘å®š
                const wasmModule = await import('./pkg/snake_game.js');
                init = wasmModule.default;
                Game = wasmModule.Game;
                console.log('JSç»‘å®šåŠ è½½æˆåŠŸ');

                console.log('å¼€å§‹åˆå§‹åŒ–WASMæ¨¡å—...');
                document.getElementById('loading').textContent = 'æ­£åœ¨åˆå§‹åŒ–WASMæ¨¡å—...';

                // å°è¯•åˆå§‹åŒ–WASMæ¨¡å—
                await init();
                console.log('WASMæ¨¡å—åˆå§‹åŒ–æˆåŠŸ');

                document.getElementById('loading').textContent = 'æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆ...';

                // è·å–canvaså’Œcontext
                canvas = document.getElementById('game-canvas');
                if (!canvas) {
                    throw new Error('æ‰¾ä¸åˆ°æ¸¸æˆç”»å¸ƒ');
                }

                ctx = canvas.getContext('2d');
                if (!ctx) {
                    throw new Error('æ— æ³•è·å–2Dæ¸²æŸ“ä¸Šä¸‹æ–‡');
                }
                console.log('Canvasåˆå§‹åŒ–æˆåŠŸ');

                // åˆ›å»ºæ¸¸æˆå®ä¾‹
                game = new Game();
                console.log('æ¸¸æˆå®ä¾‹åˆ›å»ºæˆåŠŸ');

                // è®¾ç½®é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
                document.addEventListener('keydown', handleKeyDown);
                canvas.addEventListener('click', handleCanvasClick);

                // è®¾ç½®è™šæ‹ŸæŒ‰é”®äº‹ä»¶ç›‘å¬å™¨
                setupVirtualControls();
                console.log('äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');

                // éšè—åŠ è½½æç¤º
                document.getElementById('loading').style.display = 'none';
                document.getElementById('status').textContent = 'æ¸¸æˆä¸­';

                console.log('å¼€å§‹æ¸¸æˆå¾ªç¯');
                // å¼€å§‹æ¸¸æˆå¾ªç¯
                gameLoop();

            } catch (error) {
                console.error('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';

                let errorMsg = 'æ¸¸æˆåŠ è½½å¤±è´¥: ' + error.message;
                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    errorMsg += '\n\nè¿™å¯èƒ½æ˜¯GitHub Pagesçš„WASMæ–‡ä»¶åŠ è½½é—®é¢˜ã€‚\nè¯·å°è¯•ï¼š\n1. åˆ·æ–°é¡µé¢\n2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜\n3. ä½¿ç”¨Chromeæˆ–Firefoxæµè§ˆå™¨';
                } else if (error.message.includes('WebAssembly')) {
                    errorMsg += '\n\næ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒWebAssemblyã€‚\nè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChrome 57+, Firefox 52+, Safari 11+ï¼‰';
                }

                document.getElementById('error').innerHTML = errorMsg.replace(/\n/g, '<br>');
            }
        }

        function handleKeyDown(event) {
            if (!game) return;

            // é˜²æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚é¡µé¢æ»šåŠ¨ï¼‰
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'KeyW', 'KeyA', 'KeyS', 'KeyD', 'Space'].includes(event.code)) {
                event.preventDefault();
            }

            // å¤„ç†æ–¹å‘é”®
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'KeyW', 'KeyA', 'KeyS', 'KeyD'].includes(event.code)) {
                game.set_direction_from_key(event.code);
            }

            // å¤„ç†æš‚åœé”®
            if (event.code === 'Space') {
                togglePause();
            }
        }

        function handleCanvasClick(event) {
            if (!game) return;

            if (game.is_game_over()) {
                restartGame();
            }
        }

        function gameLoop() {
            if (!game) return;

            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            game.tick();

            // æ¸²æŸ“æ¸¸æˆ
            game.render(ctx);

            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            document.getElementById('score').textContent = game.get_score();

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            if (game.is_game_over()) {
                document.getElementById('status').textContent = 'æ¸¸æˆç»“æŸ';
                document.getElementById('status').style.color = '#ff0000';
            } else if (game.is_paused()) {
                document.getElementById('status').textContent = 'å·²æš‚åœ';
                document.getElementById('status').style.color = '#ffff00';
            } else {
                document.getElementById('status').textContent = 'æ¸¸æˆä¸­';
                document.getElementById('status').style.color = '#00ff00';
            }

            // ç»§ç»­æ¸¸æˆå¾ªç¯
            animationId = setTimeout(gameLoop, 150); // çº¦6.7 FPS
        }

        window.restartGame = function() {
            if (game) {
                game.restart();
                document.getElementById('status').textContent = 'æ¸¸æˆä¸­';
                document.getElementById('status').style.color = '#00ff00';
            }
        }

        window.togglePause = function() {
            if (game && !game.is_game_over()) {
                game.toggle_pause();
            }
        }

        function setupVirtualControls() {
            const controlButtons = document.querySelectorAll('.control-btn');

            controlButtons.forEach(button => {
                // å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                button.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    const direction = this.getAttribute('data-direction');
                    if (game) {
                        game.set_direction_from_key(direction);
                    }
                    this.style.backgroundColor = '#009900';
                });

                button.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.style.backgroundColor = '#00ff00';
                });

                // å¤„ç†é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                button.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const direction = this.getAttribute('data-direction');
                    if (game) {
                        game.set_direction_from_key(direction);
                    }
                });

                // é˜²æ­¢æŒ‰é’®è·å¾—ç„¦ç‚¹
                button.addEventListener('focus', function() {
                    this.blur();
                });
            });
        }

        // æ£€æŸ¥WebAssemblyæ”¯æŒ
        function checkWebAssemblySupport() {
            if (typeof WebAssembly === 'undefined') {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebAssemblyã€‚è¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChrome 57+, Firefox 52+, Safari 11+ï¼‰';
                return false;
            }
            return true;
        }

        // å¯åŠ¨æ¸¸æˆ
        if (checkWebAssemblySupport()) {
            run();
        }
    </script>
</body>
</html>
